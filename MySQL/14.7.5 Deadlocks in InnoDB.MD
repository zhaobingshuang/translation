### 14.7.5 Deadlocks in InnoDB

- [14.7.5.1 An InnoDB Deadlock Example](https://dev.mysql.com/doc/refman/5.7/en/innodb-deadlock-example.html)
- [14.7.5.2 Deadlock Detection](https://dev.mysql.com/doc/refman/5.7/en/innodb-deadlock-detection.html)
- [14.7.5.3 How to Minimize and Handle Deadlocks](https://dev.mysql.com/doc/refman/5.7/en/innodb-deadlocks-handling.html)

死锁是指由于每个事务都持有对方需要的锁而无法继续执行的情况。两个事务都在等待资源变为可用，且都不会释放它持有的锁。

当多个事务以==相反的顺序==锁定多个表中的行时（通过 [`UPDATE`](https://dev.mysql.com/doc/refman/5.7/en/update.html) 或 [`SELECT ... FOR UPDATE`](https://dev.mysql.com/doc/refman/5.7/en/select.html)），就可能发生死锁。当此类语句锁定索引记录和间隙的范围时，由于==时序问题==，每个事务都获得了一些锁而没有获得其他锁，也会发生死锁。有关死锁的示例，see [Section 14.7.5.1, “An InnoDB Deadlock Example”](https://dev.mysql.com/doc/refman/5.7/en/innodb-deadlock-example.html)。

为了减少发生死锁的可能性，请使用事务而不是 [`LOCK TABLES`](https://dev.mysql.com/doc/refman/5.7/en/lock-tables.html) 语句；保证==插入或更新数据的事务足够小==，以免它们长时间处于开放状态；当不同的事务更新多个表或大范围的行时，==保证每个事务中操作（例如 SELECT ... FOR UPDATE）的顺序是相同==；在 SELECT ... FOR UPDATE 和 UPDATE ... WHERE 语句中==使用的列上创建索引==。死锁的可能性==不受隔离级别的影响==，因为隔离级别更改了读取操作的行为，==而死锁则是由于写入操作而发生的==。有关避免死锁和从死锁中恢复的更多信息，see [Section 14.7.5.3, “How to Minimize and Handle Deadlocks”](https://dev.mysql.com/doc/refman/5.7/en/innodb-deadlocks-handling.html)。

当启用了死锁检测（默认）并且确实发生了死锁时，InnoDB 会检测到这种情况并==回滚其中一个事务（受害方）==。如果使用 [`innodb_deadlock_detect`](https://dev.mysql.com/doc/refman/5.7/en/innodb-parameters.html#sysvar_innodb_deadlock_detect) 配置选项禁用了死锁检测，则 InnoDB 将依靠 [`innodb_lock_wait_timeout`](https://dev.mysql.com/doc/refman/5.7/en/innodb-parameters.html#sysvar_innodb_lock_wait_timeout) 设置在发生死锁的时回滚事务。因此，即使应用程序的逻辑是正确的，你仍然必须处理必须重试事务的情况。可以使用 [`SHOW ENGINE INNODB STATUS`](https://dev.mysql.com/doc/refman/5.7/en/show-engine.html) 命令查看 InnoDB 的最后一次死锁。如果频繁的死锁凸显了事务结构或应用程序错误处理方面的问题，请在启用 [`innodb_print_all_deadlocks`](https://dev.mysql.com/doc/refman/5.7/en/innodb-parameters.html#sysvar_innodb_print_all_deadlocks) 设置的情况下运行，以将所有死锁的信息打印到 [**mysqld**](https://dev.mysql.com/doc/refman/5.7/en/mysqld.html) 错误日志中。有关如何自动检测和处理死锁的更多信息，see [Section 14.7.5.2, “Deadlock Detection”](https://dev.mysql.com/doc/refman/5.7/en/innodb-deadlock-detection.html)。