#### 14.7.2.2 autocommit, Commit, and Rollback

在 InnoDB 中，所有的用户活动都在事务内部进行。如果启用了 [`autocommit`](https://dev.mysql.com/doc/refman/5.7/en/server-system-variables.html#sysvar_autocommit) 模式，则每个 SQL 语句都单独形成一个事务。默认情况下，MySQL 会在启用autocommit 的情况下为每个新连接启动会话，因此如果该 SQ L语句未返回错误，则 MySQL 在每个 SQL 语句之后执行一次提交。==如果发生了错误，则提交或回退行为取决于该错误的类型==。See [Section 14.22.4, “InnoDB Error Handling”](https://dev.mysql.com/doc/refman/5.7/en/innodb-error-handling.html)。

启用了 [`autocommit`](https://dev.mysql.com/doc/refman/5.7/en/server-system-variables.html#sysvar_autocommit) 功能的会话可以通过显式的  [`START TRANSACTION`](https://dev.mysql.com/doc/refman/5.7/en/commit.html) 或 [`BEGIN`](https://dev.mysql.com/doc/refman/5.7/en/commit.html)  语句开始并以 [`COMMIT`](https://dev.mysql.com/doc/refman/5.7/en/commit.html) 或 [`ROLLBACK`](https://dev.mysql.com/doc/refman/5.7/en/commit.html) 语句结束的方式执行多语句事务。See [Section 13.3.1, “START TRANSACTION, COMMIT, and ROLLBACK Statements”](https://dev.mysql.com/doc/refman/5.7/en/commit.html)。

==如果使用 `SET autocommit = 0` 禁用了事务的 [`autocommit`](https://dev.mysql.com/doc/refman/5.7/en/server-system-variables.html#sysvar_autocommit)，则该会话总是会有一个打开的事务。[`COMMIT`](https://dev.mysql.com/doc/refman/5.7/en/commit.html) 或 [`ROLLBACK`](https://dev.mysql.com/doc/refman/5.7/en/commit.html) 语句会结束当前事务，并开始新的事务。==

如果禁用了 [`autocommit`](https://dev.mysql.com/doc/refman/5.7/en/server-system-variables.html#sysvar_autocommit) 的会话在没有显式提交事务的情况下结束，则 MySQL 将回滚该事务。

有些语句会隐式地结束事务，就像您在执行该语句之前执行了 COMMIT 一样。详见 [Section 13.3.3, “Statements That Cause an Implicit Commit”](https://dev.mysql.com/doc/refman/5.7/en/implicit-commit.html)。

COMMIT 意味着当前事务中所做的更改将会被持久化，并对其他会话可见。另一方面，ROLLBACK 语句会取消当前事务所做的所有修改。COMMIT 和 ROLLBACK 都会释放当前事务加的所有 InnoDB 锁。

##### Grouping DML Operations with Transactions

默认情况下，连接到 MySQL 会启用 [autocommit](https://dev.mysql.com/doc/refman/5.7/en/glossary.html#glos_autocommit) ，会自动提交你执行每一条SQL语句。如果你有其他数据库系统的经验，则可能不熟悉这种操作模式。在其他数据库系统中，标准的做法是执行一系列 DML 语句并一起提交或回滚它们。

要使用多语句的事务，请使用 SQL 语句`SET autocommit = 0`关闭自动提交并在适当时间以 COMMIT 或 ROLLBACK 结束每个事务。要保留自动提交功能，请以 [`START TRANSACTION`](https://dev.mysql.com/doc/refman/5.7/en/commit.html) 开始每个事务，并以 [`COMMIT`](https://dev.mysql.com/doc/refman/5.7/en/commit.html) 或 [`ROLLBACK`](https://dev.mysql.com/doc/refman/5.7/en/commit.html) 结束它。下面的示例显示了两个事务。第一个被提交；第二个被回滚。

```sql
shell> mysql test
```

```sql
mysql> CREATE TABLE customer (a INT, b CHAR (20), INDEX (a));
Query OK, 0 rows affected (0.00 sec)
mysql> -- Do a transaction with autocommit turned on.
mysql> START TRANSACTION;
Query OK, 0 rows affected (0.00 sec)
mysql> INSERT INTO customer VALUES (10, 'Heikki');
Query OK, 1 row affected (0.00 sec)
mysql> COMMIT;
Query OK, 0 rows affected (0.00 sec)
mysql> -- Do another transaction with autocommit turned off.
mysql> SET autocommit=0;
Query OK, 0 rows affected (0.00 sec)
mysql> INSERT INTO customer VALUES (15, 'John');
Query OK, 1 row affected (0.00 sec)
mysql> INSERT INTO customer VALUES (20, 'Paul');
Query OK, 1 row affected (0.00 sec)
mysql> DELETE FROM customer WHERE b = 'Heikki';
Query OK, 1 row affected (0.00 sec)
mysql> -- Now we undo those last 2 inserts and the delete.
mysql> ROLLBACK;
Query OK, 0 rows affected (0.00 sec)
mysql> SELECT * FROM customer;
+------+--------+
| a    | b      |
+------+--------+
|   10 | Heikki |
+------+--------+
1 row in set (0.00 sec)
mysql>s
```

**Transactions in Client-Side Languages**

在诸如PHP、Perl DBI、JDBC、ODBC 或 MySQL的标准 C 接口等 API 中，您可以像其他任何 SQL 语句（例如 SELECT 或 INSERT）一样，将事务控制语句（例如 COMMIT）作为字符串发送到 MySQL 服务器。一些 API 还提供了单独的特殊事务提交和回滚功能或方法。

